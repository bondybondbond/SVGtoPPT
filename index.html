<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG to PowerPoint Converter</title>
    <!-- Add integrity hash to ensure secure loading -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.js" integrity="sha512-X9+SPQovcsiOYthV3YFMt7R/Z5UpF4cCHv2tb3pYJS9CnMIRxOGzgZNyKZCdNJTFkfnzBYeN9QiKnZf1OYCXJg==" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        h1 {
            color: #0066cc;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: monospace;
            margin-bottom: 20px;
        }
        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 15px;
            width: 100%;
        }
        button:hover {
            background-color: #0055aa;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .preview-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            overflow: auto;
            min-height: 150px;
            max-height: 300px;
        }
        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success { background-color: #e6f7e6; color: #2e7d32; }
        .error { background-color: #ffebee; color: #c62828; }
        .warning { background-color: #fff8e1; color: #f57c00; }
        
        .sample-button {
            background-color: #f0f0f0;
            color: #333;
            padding: 8px 15px;
            margin-right: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        .sample-button:hover {
            background-color: #e0e0e0;
        }
        .library-status {
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
            padding: 5px 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .loading-dot {
            height: 10px;
            width: 10px;
            background-color: #0066cc;
            border-radius: 50%;
            margin-right: 10px;
            display: inline-block;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 1; }
            100% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <h1>SVG to PowerPoint Converter</h1>
    
    <div class="container">
        <div id="libraryStatus" class="library-status">
            <span class="loading-dot"></span>
            <span id="libraryStatusText">Checking PowerPoint library...</span>
        </div>
        
        <h2>Step 1: Choose an SVG</h2>
        <div style="margin-bottom: 15px;">
            <button class="sample-button" id="basicShapes">Sample: Basic Shapes</button>
            <button class="sample-button" id="simpleChart">Sample: Chart</button>
            <button class="sample-button" id="flowchart">Sample: Flowchart</button>
        </div>
        
        <div>
            <label for="svgInput">SVG Code:</label>
            <textarea id="svgInput" placeholder="<svg>...</svg>"></textarea>
        </div>
        
        <h2>Step 2: Preview</h2>
        <div id="previewContainer" class="preview-container">
            <div id="svgPreview" style="display: flex; justify-content: center;"></div>
        </div>
        
        <h2>Step 3: Convert</h2>
        <button id="convertButton" disabled>Convert to PowerPoint</button>
        
        <div id="statusMessage" class="status" style="display: none;"></div>
    </div>

    <script>
        // Global flag for library loaded status
        let pptxLibraryLoaded = false;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const svgInput = document.getElementById('svgInput');
            const convertButton = document.getElementById('convertButton');
            const statusMessage = document.getElementById('statusMessage');
            const svgPreview = document.getElementById('svgPreview');
            const libraryStatus = document.getElementById('libraryStatus');
            const libraryStatusText = document.getElementById('libraryStatusText');
            
            // Sample buttons
            const basicShapesBtn = document.getElementById('basicShapes');
            const simpleChartBtn = document.getElementById('simpleChart');
            const flowchartBtn = document.getElementById('flowchart');
            
            // Sample SVGs
            const sampleSVGs = {
                'basicShapes': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300">
                    <rect x="50" y="50" width="100" height="100" fill="#4285f4" />
                    <circle cx="250" cy="100" r="50" fill="#ea4335" />
                    <polygon points="100,200 150,250 50,250" fill="#fbbc05" />
                    <ellipse cx="250" cy="225" rx="75" ry="50" fill="#34a853" />
                </svg>`,
                'simpleChart': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300">
                    <line x1="50" y1="250" x2="350" y2="250" stroke="black" stroke-width="2" />
                    <line x1="50" y1="250" x2="50" y2="50" stroke="black" stroke-width="2" />
                    <rect x="75" y="150" width="50" height="100" fill="#4285f4" />
                    <rect x="175" y="100" width="50" height="150" fill="#ea4335" />
                    <rect x="275" y="180" width="50" height="70" fill="#34a853" />
                    <text x="200" y="30" text-anchor="middle" font-family="Arial" font-size="16">Simple Bar Chart</text>
                    <text x="200" y="280" text-anchor="middle" font-family="Arial" font-size="14">Categories</text>
                    <text x="30" y="150" text-anchor="middle" transform="rotate(-90,30,150)" font-family="Arial" font-size="14">Values</text>
                </svg>`,
                'flowchart': `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 300">
                    <rect x="150" y="20" width="100" height="50" rx="10" fill="#e6f7ff" stroke="#1890ff" stroke-width="2" />
                    <text x="200" y="45" text-anchor="middle" font-family="Arial" font-size="14">Start</text>
                    
                    <rect x="150" y="120" width="100" height="50" rx="0" fill="#fff7e6" stroke="#fa8c16" stroke-width="2" />
                    <text x="200" y="145" text-anchor="middle" font-family="Arial" font-size="14">Process</text>
                    
                    <polygon points="200,220 240,250 200,280 160,250" fill="#f6ffed" stroke="#52c41a" stroke-width="2" />
                    <text x="200" y="255" text-anchor="middle" font-family="Arial" font-size="14">Decision</text>
                    
                    <line x1="200" y1="70" x2="200" y2="120" stroke="#666" stroke-width="2" />
                    <line x1="200" y1="170" x2="200" y2="220" stroke="#666" stroke-width="2" />
                    
                    <polygon points="195,80 200,100 205,80" fill="#666" />
                    <polygon points="195,190 200,210 205,190" fill="#666" />
                </svg>`
            };
            
            // Check for PowerPoint library with retries
            checkLibraryWithRetry();
            
            function checkLibraryWithRetry(retries = 5, delay = 1000) {
                console.log('Checking for PptxGenJS library...');
                
                // Check if library is available
                if (typeof PptxGenJS !== 'undefined') {
                    console.log('PptxGenJS library found');
                    pptxLibraryLoaded = true;
                    libraryStatusText.textContent = 'PowerPoint library loaded successfully!';
                    libraryStatus.style.backgroundColor = '#e6f7e6';
                    libraryStatus.querySelector('.loading-dot').style.display = 'none';
                    convertButton.disabled = false;
                    return;
                }
                
                // Decrement retry counter
                retries--;
                
                if (retries <= 0) {
                    console.log('Failed to load PptxGenJS after multiple attempts');
                    libraryStatusText.textContent = 'PowerPoint library not loaded. Loading backup...';
                    loadBackupLibrary();
                    return;
                }
                
                libraryStatusText.textContent = `Loading PowerPoint library (${5-retries}/5)...`;
                console.log(`Will retry in ${delay}ms. Attempts left: ${retries}`);
                
                // Retry after delay
                setTimeout(() => {
                    checkLibraryWithRetry(retries, delay);
                }, delay);
            }
            
            // Load backup library
            function loadBackupLibrary() {
                console.log('Loading backup PptxGenJS library');
                
                // Try alternate CDN
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js';
                script.async = true;
                
                script.onload = function() {
                    console.log('Backup PptxGenJS library loaded successfully');
                    pptxLibraryLoaded = true;
                    libraryStatusText.textContent = 'PowerPoint library loaded successfully!';
                    libraryStatus.style.backgroundColor = '#e6f7e6';
                    libraryStatus.querySelector('.loading-dot').style.display = 'none';
                    convertButton.disabled = false;
                };
                
                script.onerror = function() {
                    console.log('Backup library failed to load');
                    libraryStatusText.textContent = 'Failed to load PowerPoint library. Try refreshing the page.';
                    libraryStatus.style.backgroundColor = '#ffebee';
                    libraryStatus.querySelector('.loading-dot').style.display = 'none';
                    showStatus('Unable to load PowerPoint conversion library. This may be blocked by your browser.', 'error');
                };
                
                document.head.appendChild(script);
            }
            
            // Sample SVG buttons
            basicShapesBtn.addEventListener('click', function() {
                svgInput.value = sampleSVGs.basicShapes;
                updatePreview();
            });
            
            simpleChartBtn.addEventListener('click', function() {
                svgInput.value = sampleSVGs.simpleChart;
                updatePreview();
            });
            
            flowchartBtn.addEventListener('click', function() {
                svgInput.value = sampleSVGs.flowchart;
                updatePreview();
            });
            
            // Update preview when SVG input changes
            svgInput.addEventListener('input', function() {
                updatePreview();
            });
            
            function updatePreview() {
                const svgCode = svgInput.value.trim();
                if (svgCode && svgCode.startsWith('<svg')) {
                    try {
                        // Basic sanitization
                        const sanitizedSVG = svgCode
                            .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                            .replace(/on\w+="[^"]*"/g, '')
                            .replace(/on\w+='[^']*'/g, '');
                        
                        svgPreview.innerHTML = sanitizedSVG;
                        
                        // Make SVG responsive
                        const svg = svgPreview.querySelector('svg');
                        if (svg) {
                            svg.setAttribute('width', '100%');
                            svg.setAttribute('height', 'auto');
                            svg.style.maxHeight = '250px';
                        }
                    } catch (error) {
                        svgPreview.innerHTML = `<p style="color: red;">Error previewing SVG: ${error.message}</p>`;
                    }
                } else {
                    svgPreview.innerHTML = '<p style="text-align: center; color: #999;">SVG preview will appear here</p>';
                }
            }
            
            // Convert SVG to PowerPoint
            convertButton.addEventListener('click', function() {
                if (!pptxLibraryLoaded) {
                    showStatus('PowerPoint library is not ready yet. Please wait a moment and try again.', 'warning');
                    return;
                }
                
                const svgCode = svgInput.value.trim();
                
                if (!svgCode || !svgCode.startsWith('<svg')) {
                    showStatus('Please enter valid SVG code', 'error');
                    return;
                }
                
                showStatus('Converting... Please wait', 'warning');
                
                // Create a new instance of PptxGenJS
                let pptx;
                try {
                    pptx = new PptxGenJS();
                    console.log('PptxGenJS instance created successfully');
                } catch (e) {
                    console.error('Error creating PptxGenJS instance:', e);
                    showStatus('Error initializing PowerPoint generator: ' + e.message, 'error');
                    return;
                }
                
                try {
                    // Sanitize SVG
                    const sanitizedSVG = svgCode
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                        .replace(/on\w+="[^"]*"/g, '')
                        .replace(/on\w+='[^']*'/g, '');
                    
                    // Create standard widescreen slide
                    try {
                        pptx.layout = 'LAYOUT_16x9';
                        console.log('Set slide layout to 16:9');
                    } catch (e) {
                        console.error('Error setting slide layout:', e);
                        // Continue anyway with default layout
                    }
                    
                    // Add a slide
                    const slide = pptx.addSlide();
                    console.log('Slide added');
                    
                    // Create temp element to parse SVG
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = sanitizedSVG;
                    const svgElement = tempDiv.querySelector('svg');
                    
                    if (!svgElement) {
                        showStatus('Invalid SVG structure detected', 'error');
                        return;
                    }
                    
                    // Convert SVG to base64
                    const svgData = new XMLSerializer().serializeToString(svgElement);
                    console.log('SVG serialized successfully');
                    
                    // Unicode handling - safer approach
                    const svgBlob = new Blob([svgData], {type: 'image/svg+xml'});
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const svgBase64 = e.target.result;
                        console.log('SVG converted to base64');
                        
                        // Add SVG to slide
                        try {
                            slide.addImage({
                                data: svgBase64,
                                x: 0,
                                y: 0,
                                w: '100%',
                                h: '100%'
                            });
                            console.log('Image added to slide');
                            
                            // Save the PowerPoint file
                            console.log('Writing file...');
                            pptx.writeFile({ fileName: 'svg-slide.pptx' })
                                .then(function() {
                                    console.log('File written successfully');
                                    showStatus('PowerPoint file created successfully!', 'success');
                                })
                                .catch(function(error) {
                                    console.error('Error writing file:', error);
                                    showStatus('Error creating PowerPoint file: ' + error.message, 'error');
                                });
                        } catch (err) {
                            console.error('Error adding image to slide:', err);
                            showStatus('Error adding image to slide: ' + err.message, 'error');
                        }
                    };
                    
                    reader.onerror = function() {
                        showStatus('Error reading SVG data', 'error');
                    };
                    
                    reader.readAsDataURL(svgBlob);
                    
                } catch (error) {
                    console.error('General conversion error:', error);
                    showStatus('Error during conversion: ' + error.message, 'error');
                }
            });
            
            function showStatus(message, type) {
                console.log('Status:', message, type);
                statusMessage.textContent = message;
                statusMessage.className = 'status ' + type;
                statusMessage.style.display = 'block';
                
                // Hide success/warning messages after 8 seconds, keep errors visible
                if (type !== 'error') {
                    setTimeout(function() {
                        statusMessage.style.display = 'none';
                    }, 8000);
                }
            }
            
            // Initialize
            updatePreview();
            
            // Add sample SVG on load
            if (!svgInput.value) {
                svgInput.value = sampleSVGs.basicShapes;
                updatePreview();
            }
        });
    </script>
</body>
</html>
